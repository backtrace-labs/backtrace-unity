name: Build package

on:
  push:
    branches: [master]
  pull_request:

jobs:
  test:
    name: Run Build for ${{ matrix.unityVersion }} ${{ matrix.targetPlatform }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        projectPath: [test-package]
        unityVersion:
          - 2022.3.56f1
        targetPlatform:
          - StandaloneOSX
          - StandaloneWindows
          - StandaloneWindows64
          - StandaloneLinux64
          - iOS
          - Android
          - WebGL
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Environment
        run: |
          mkdir -p ${{ matrix.projectPath }}
          mv Editor Runtime Tests Android iOS Windows package.json ${{ matrix.projectPath }}/

      - name: Inject temp scene (avoid "Cannot build untitled scene")
        run: |
          mkdir -p ${{ matrix.projectPath }}/Assets/__CI__ ${{ matrix.projectPath }}/ProjectSettings
          cat > ${{ matrix.projectPath }}/Assets/__CI__/Empty.unity <<'EOF'
          %YAML 1.1
          %TAG !u! tag:unity3d.com,2011:
          --- !u!1 &1000
          GameObject:
            m_ObjectHideFlags: 0
            m_Component: []
            m_Layer: 0
            m_Name: __CI__Empty
            m_IsActive: 1
          EOF
          cat > ${{ matrix.projectPath }}/ProjectSettings/EditorBuildSettings.asset <<'EOF'
          %YAML 1.1
          %TAG !u! tag:unity3d.com,2011:
          --- !u!1045 &1
          EditorBuildSettings:
            serializedVersion: 2
            m_Scenes:
            - enabled: 1
              path: Assets/__CI__/Empty.unity
              guid: 0000000000000000d000000000000000
            m_configObjects: {}
          EOF

      - if: matrix.targetPlatform == 'Android'
        uses: jlumbroso/free-disk-space@v1.3.1

      # Build only platforms Unity can build on Linux runners
      - name: Build (Linux-supported targets)
        if: |
          matrix.targetPlatform == 'StandaloneLinux64' ||
          matrix.targetPlatform == 'Android' ||
          matrix.targetPlatform == 'WebGL'
        uses: game-ci/unity-builder@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        with:
          unityVersion: ${{ matrix.unityVersion }}
          targetPlatform: ${{ matrix.targetPlatform }}
          projectPath: ${{ matrix.projectPath }}/
          allowDirtyBuild: true

      # without attempting impossible builds on Linux
      - name: Skip unsupported on ubuntu-latest
        if: |
          matrix.targetPlatform == 'StandaloneOSX' ||
          matrix.targetPlatform == 'StandaloneWindows' ||
          matrix.targetPlatform == 'StandaloneWindows64' ||
          matrix.targetPlatform == 'iOS'
        run: echo "Skipping ${{ matrix.targetPlatform }} on ubuntu-latest"
